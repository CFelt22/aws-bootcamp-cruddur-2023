# Week 5 â€” DynamoDB and Serverless Caching
The first step was to inject data in the local DynamoDB to make sure the data was displaying properly in the app. The second step was to create the DynamoDB database in AWS to use it for production. I had some problems to display the data properly with the local database. Previously, I had problems with the conection url. It took me a lot of time to figure out that I need to change the variable of CONNECTION_URL and LOCAL_CONNECTION_URL while seeding the local DB and the local DynamoDB. Some of the steps executed by the setup bash script were not working.

## Restructuring bash scripts
We changed some of the bash script to have a better structure in the directories.

## Utility scripts

### Adding boto3
We added boto3 to the requirements.txt file and installed it.
![requirements.txt](/journal/assets/requirements1-w5.png "boto3")
[requirements.txt](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/b367d924e8c1b00c828c50c448740272fee6931a/backend-flask/requirements.txt)

### Schema-load
We added a file to create the bash file to create the schema in the DynamoDB table.
![schema-load](/journal/assets/schema-load1-w5.png "schema-load")
[schema-load](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/b367d924e8c1b00c828c50c448740272fee6931a/backend-flask/bin/ddb/schema-load)

### Drop table
This script is used to drop a table.
![drop](/journal/assets/drop1-w5.png "drop")
[drop](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/4a8abc50ac1e45498c98ff7ed22510ea382937a5/backend-flask/bin/ddb/drop)

### List tables
This script is used to list tables in the database
![list-tables](/journal/assets/list1-w5.png "list-tables")
[list-tables](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/4a8abc50ac1e45498c98ff7ed22510ea382937a5/backend-flask/bin/ddb/list-tables)

### Scan
This script is used to scan items in the table.
![scan](/journal/assets/scan1-w5.png "scan")
[scan](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/4a8abc50ac1e45498c98ff7ed22510ea382937a5/backend-flask/bin/ddb/scan)

### Seed
This script is used to inject mock data inside the DynamoDb table.
![seed](/journal/assets/seed1-w5.png "seed")
[seed](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/4a8abc50ac1e45498c98ff7ed22510ea382937a5/backend-flask/bin/ddb/seed)

### Get Conversations
This script is used to get the content of the mock conversation and see the data.
![get-conservations](/journal/assets/get-conv1-w5.png "get-conservations")
[get-conservations](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/fcb935b874450daebf48781e0833ec15f13f87eb/backend-flask/bin/ddb/patterns/get-conversation)

### List Conversations
This script is used to list the mock conversation and see the data.
![list-conversations](/journal/assets/list-conv1-w5.png "list-conversations")
[list-conversations](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/fcb935b874450daebf48781e0833ec15f13f87eb/backend-flask/bin/ddb/patterns/list-conversations)

### db.py
We modified this script to add parameters and to query values.
![db.py](/journal/assets/db1-w5.png "db.py")
[db.py](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/d373a925dacd057b779e3432bd8ef9d41a4ce1aa/backend-flask/lib/db.py)

## Implement conversations

### Gitpod.yaml
we automated the installation of the modules included in the requirements.txt file at the launch of Gitpod.
![gitpod.yaml](/journal/assets/gitpod1-w5.png "gitpod.yaml")
[gitpod.yaml](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/1424a39bedbde7eaec3e45c0b788ebc8da5c8d4c/.gitpod.yml)

### App.py
We passed the authentication token to the group messages.
![app.py](/journal/assets/app1-w5.png "app.py")
[app.py](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/1424a39bedbde7eaec3e45c0b788ebc8da5c8d4c/backend-flask/app.py)

### List Users
This is to query cognito users from AWS Cognito.
![list-users](/journal/assets/list-u1-w5.png "list-users")
[list-users](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/1424a39bedbde7eaec3e45c0b788ebc8da5c8d4c/backend-flask/bin/cognito/list-users)

### Update Cognito Users Id
This is to update the users in the local db, to give the the uuid generated by AWS Cognito.
![update dognito users id](/journal/assets/update1-w5.png "update dognito users id")
[update dognito users id](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/1424a39bedbde7eaec3e45c0b788ebc8da5c8d4c/backend-flask/bin/db/update_cognito_user_ids)

### Setup
We added the update cognito users Id in the setup bash script.
![setup](/journal/assets/setup1-w5.png "setup")
[setup](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/1424a39bedbde7eaec3e45c0b788ebc8da5c8d4c/backend-flask/bin/db/setup)

### UUID from Cognito User Id
This is to query users uuid from AWS Cognito.
![uuid](/journal/assets/uuid1-w5.png "uuid")
[uuid](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/1424a39bedbde7eaec3e45c0b788ebc8da5c8d4c/backend-flask/db/sql/users/uuid_from_cognito_user_id.sql)

### DDB.py
This is the python script for DynamoDB.
![ddb.py](/journal/assets/ddb1-w5.png "")
[](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/1424a39bedbde7eaec3e45c0b788ebc8da5c8d4c/backend-flask/lib/ddb.py)

### message_groups.py
![ddb.py](/journal/assets/ddb1-w5.png "ddb.py")
[ddb.py](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/1424a39bedbde7eaec3e45c0b788ebc8da5c8d4c/backend-flask/services/message_groups.py)

### CheckAuth
We created a javascript file to use it as a librairy and we removed the checkAuth code in the HomeFeedPage.js file.
![CheckAuth](/journal/assets/checkauth1-w5.png "CheckAuth")
[CheckAuth](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/1424a39bedbde7eaec3e45c0b788ebc8da5c8d4c/frontend-react-js/src/lib/CheckAuth.js)

### Authorization
We added the bearer authorization token in the headers. We added it to these files : MessageForm.js, MessageGroupPage.js, MessageGroupsPage.js, 
![Authorization](/journal/assets/auth1-w5.png "Authorization")
[Authorization](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/1424a39bedbde7eaec3e45c0b788ebc8da5c8d4c/frontend-react-js/src/pages/MessageGroupPage.js)

## Troubleshooting

### Changing source in setup
This is a solution I found on the discord channel. In order to get rid of the error message when we use the setup script, we need to change *source* for *python* for the execution of the *update_cognito_user_id* script.
![setup](/journal/assets/setup2-w5.png "setup")
[setup](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/6216c3886a60f3f61fd94a7a95dbdb9da4e4a42a/backend-flask/bin/db/setup)

### Displaying data in the application
I had many problems to display the data in the application. In previous weeks, I had problems with the connection url and I still have problems with it. In order to seed data for the db I need to use the *CONNECTION_URL* in the db.py file. When I want to seed the ddb, I need to use the *LOCAL_CONNECTION_URL*, but the data won't display in the app. Once it's seeded, I need to change it back to *CONNECTION_URL* to display the data. It took me a while to figure that. After that, everything was working properly.

### Timestamp problem
The time in the conversation was not displaying properly. I found in the discord channel someone had posted a solution. It didn't worked the right way, all the messages were 1h ago. I modified it to be like this.
![Time](/journal/assets/time1-w5.png "Time")
[Time](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/bb12e94c64e0d41f4a235eccfc59dd3e62386c48/backend-flask/bin/ddb/seed)
![Conversation](/journal/assets/conv1-w5.png "Conversation")

## DynamoDB in production
We created a DynamoDB database in AWS. The application will store messages inside. 

### Lambda function
This is the lambda function that is trigerred by DynamoDB to query the items in the DB.
![Lambda](/journal/assets/lambda2-w5.png "Lambda")
[Lambda](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/91d620906c880fa30fc936f851d01da9d7879b9c/aws/lambdas/cruddur-messaging-stream.py)

### Policy
This is the policy attached to the lambda function to put, delete and query item.
![Policy](/journal/assets/policy1-w5.png "Policy")
[Policy](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/91d620906c880fa30fc936f851d01da9d7879b9c/aws/policies/cruddur-message-stream-policy.json)

### Schema-load
We added the message group uuid and the global index to the schema-load file.
![schema-load](/journal/assets/schemaload1-w5.png "schema-load")
[schema-load](https://github.com/CFelt22/aws-bootcamp-cruddur-2023/blob/91d620906c880fa30fc936f851d01da9d7879b9c/backend-flask/bin/ddb/schema-load)
This is a conversation.
![Conversation](/journal/assets/conv3-w5.png "Conversation")
Those are the items in the DynamoDB database.
![Items](/journal/assets/dbitems1-w5.png "Items")
